<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kishore's Social Post Automation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Modern, Dark, Animated Background */
        @keyframes gradient-shift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        body { 
            font-family: 'Inter', sans-serif; 
            /* Deep, animated gradient for a modern 3D background feel */
            background: linear-gradient(-45deg, #111827, #1e293b, #3b0764, #1e3a8a);
            background-size: 400% 400%;
            animation: gradient-shift 20s ease infinite;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        /* Enhanced Card Design (Floating Glass Effect) */
        .card { 
            backdrop-filter: blur(20px); 
            background-color: rgba(255, 255, 255, 0.05); /* Very subtle white background */
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3); 
            color: #f3f4f6; /* Light text color */
        }
        
        /* Input and Select Styling for Dark BG */
        .input-style {
            background-color: #374151; /* Darker input background */
            border: 1px solid #4b5563;
            color: #f3f4f6;
            transition: all 0.2s;
        }
        .input-style::placeholder {
            color: #9ca3af;
        }
        .input-style:focus {
             box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.5); /* Indigo glow */
             border-color: #6366f1;
        }

        /* Button Enhancements */
        .btn-primary { 
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative;
            overflow: hidden;
            z-index: 1;
        }
        .btn-primary:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 6px 15px rgba(99, 102, 241, 0.4); 
        }
        .btn-primary:active { transform: translateY(0); }

        /* Loading Spinner */
        .loading-ring { border: 4px solid rgba(255, 255, 255, 0.2); border-top: 4px solid #6366f1; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="p-4">

    <!-- Main Container -->
    <div id="app" class="w-full max-w-3xl">

        <!-- Login Screen -->
        <div id="login-screen" class="card p-10 rounded-2xl space-y-6">
            <h2 class="text-4xl font-extrabold text-white text-center">üîê Content Automation Login</h2>
            <p class="text-center text-gray-400">Please enter your credentials to access the dashboard.</p>
            <input type="text" id="username" placeholder="Username" class="w-full p-4 rounded-lg input-style">
            <input type="password" id="password" placeholder="Secret Code" class="w-full p-4 rounded-lg input-style">
            <button onclick="handleLogin()" class="w-full p-4 bg-indigo-600 text-white font-bold text-lg rounded-lg btn-primary hover:bg-indigo-700">Access Dashboard</button>
            <p id="login-message" class="text-center text-sm text-red-400"></p>
        </div>

        <!-- Dashboard Screen -->
        <div id="dashboard-screen" class="hidden">
            <div class="card p-10 rounded-2xl space-y-8">
                <h2 class="text-4xl font-extrabold text-white text-center tracking-wider">‚ú® Social Post Automation</h2>
                
                <!-- GitHub Token Input -->
                <div class="space-y-2">
                    <label for="github-token" class="block text-sm font-medium text-gray-300">GitHub Personal Access Token (for fetching files)</label>
                    <input type="password" id="github-token" placeholder="Enter your GitHub Token" class="w-full p-3 rounded-lg input-style" onchange="checkSelection()">
                </div>

                <!-- AI Caption Generator Section -->
                <div class="space-y-4 p-6 border border-indigo-500 rounded-xl bg-indigo-900/30">
                    <h3 class="text-xl font-bold text-indigo-300">ü§ñ AI Caption Generator</h3>

                    <div class="space-y-2">
                        <label for="ai-topic" class="block text-sm font-medium text-gray-300">Core Post Topic / Idea</label>
                        <textarea id="ai-topic" rows="3" placeholder="e.g., The importance of Python automation to save development time..." class="w-full p-3 rounded-lg input-style">The importance of using Python for API automation to save development time.</textarea>
                    </div>

                    <div class="flex space-x-4">
                        <div class="flex-1 space-y-2">
                            <label for="ai-platform" class="block text-sm font-medium text-gray-300">Target Platform</label>
                            <select id="ai-platform" class="w-full p-3 rounded-lg input-style">
                                <option value="LinkedIn">LinkedIn (Professional)</option>
                                <option value="Instagram">Instagram (Engaging & Visual)</option>
                            </select>
                        </div>
                        <div class="flex-1 space-y-2">
                             <label for="ai-tone" class="block text-sm font-medium text-gray-300">Desired Tone</label>
                            <input type="text" id="ai-tone" value="Professional, insightful, and slightly inspirational" class="w-full p-3 rounded-lg input-style">
                        </div>
                    </div>
                    
                    <button id="ai-generate-button" onclick="generateAICaption()" class="w-full p-3 bg-pink-600 text-white font-semibold rounded-lg btn-primary hover:bg-pink-700">
                        Generate Caption with AI
                    </button>

                    <div class="space-y-2">
                        <label for="ai-output" class="block text-sm font-medium text-gray-300">Generated Caption</label>
                        <textarea id="ai-output" rows="5" readonly placeholder="Your new caption will appear here..." class="w-full p-3 rounded-lg input-style bg-gray-800/50"></textarea>
                    </div>
                </div>

                <!-- Date Selector -->
                <div class="space-y-2">
                    <div class="flex justify-between items-center">
                        <label for="content-date" class="block text-sm font-medium text-gray-300">Select Content Date Folder</label>
                        <button onclick="fetchContentDates()" class="flex items-center space-x-2 text-indigo-400 hover:text-indigo-200 text-sm font-medium">
                            <span id="refresh-icon">üîÑ</span>
                            <span id="refresh-text">Refresh Dates</span>
                        </button>
                    </div>
                    <select id="content-date" class="w-full p-3 rounded-lg input-style" onchange="checkSelection()">
                        <option value="" disabled selected>Loading dates...</option>
                    </select>
                </div>

                <!-- Platform Selection -->
                <div class="space-y-3">
                    <label class="block text-sm font-medium text-gray-300">Select Platforms to Post</label>
                    <div class="flex space-x-8">
                        <div class="flex items-center">
                            <input id="platform-linkedin" type="checkbox" checked class="h-5 w-5 text-indigo-400 bg-gray-700 border-gray-600 rounded focus:ring-indigo-500">
                            <label for="platform-linkedin" class="ml-2 block text-base font-medium text-gray-300">LinkedIn</label>
                        </div>
                        <div class="flex items-center">
                            <input id="platform-instagram" type="checkbox" checked class="h-5 w-5 text-indigo-400 bg-gray-700 border-gray-600 rounded focus:ring-indigo-500">
                            <label for="platform-instagram" class="ml-2 block text-base font-medium text-gray-300">Instagram</label>
                        </div>
                    </div>
                </div>
                
                <!-- Post Button -->
                <button id="post-button" onclick="handlePost()" class="w-full p-4 bg-green-500 text-white font-bold text-xl rounded-lg btn-primary hover:bg-green-600 flex items-center justify-center space-x-3" disabled>
                    <span id="button-text">Select Content & Post Now</span>
                    <div id="post-spinner" class="hidden loading-ring"></div>
                </button>

                <!-- Status Output -->
                <div id="status-output" class="p-4 bg-gray-900 rounded-lg text-sm text-gray-300 space-y-2 max-h-60 overflow-y-auto border border-gray-700">
                    <p class="text-gray-500">Automation ready. Enter your GitHub Token to load content dates.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ======================================================================
        // 1. CONFIGURATION (Credentials & Repo Details)
        // ======================================================================

         const AUTH_USERNAME = 'growwithkishore';
        const AUTH_PASSWORD = 'GAYA3RIYA';

        const REPO_OWNER = "DATABASESK";
        const REPO_NAME = "kishore-personal-";
        const BRANCH = "main";
        const CONTENT_BASE_PATH = "content";
        const GITHUB_TOKEN_KEY = 'githubToken'; // Key for LocalStorage

        // --- Social Media API Access (Hardcoded for single-file deployment) ---
        const ACCESS_TOKEN_LI = "AQU7hbGJY6eq-iU4pvHW_UvOoBZnxuFZvnKOLJ_koi7jeEvEpngj5bITIrB5H0F1ukhVMqeoH4szFjLMtaRep-Ot00HbbMb7GOrzBefR29AJg_uf3nYGWMQvWIJmAt-6iSAjgSGxJaAcp4EE568n0cBMBNt2N3QUSkbW4NONh3punVgj9j0hHGpjgAf1Q_yxKjb5LjGv75zYcwcQiM38GmmDahcKSgr6oyIjI88dXtaErenwZdWUgXmyi7EreoL8WQOZe_Bt6nd5kBXSyhDUk_gXArDPu52EvnKqJaJl5fuK8pStWTi8ckLtfuADsm7h02q2rOpVJKXzagSimWcWSrRC4JfFDg"; 
        const PERSON_URN = "urn:li:person:puHZG_iSFo";                     

        const INSTAGRAM_BUSINESS_ID = "17841475537983796";             
        const ACCESS_TOKEN_IG = "EAALAZBChjLPUBPrfixdR9fDuwvgKouoYpgue8pQxUCm3SPT7Muh8C0EZCjcoDN1tZAbGVwzWZA0rqc7ZBDrZBA9TgZBGpxQx5HYv4bZCapOzoEcZCbL3FzPyL8ZB4h16GW6QayBpyvMJywW8PVJAlGUB8ZCBteLr5Dv3CpfGtn7DD4HcmCZBD6yHZAi6G1HFAfYoN"; 
        
        // --- Gemini AI Configuration ---
        const GEMINI_API_KEY = "AIzaSyBpb0ZeqVlpvHMrDMuJkPFCa-2zc8cZ_bA"; // Canvas handles this key
        const GEMINI_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent";


        // ======================================================================
        // 2. STATE MANAGEMENT & UI HELPERS
        // ======================================================================
        let githubToken = '';
        let selectedDate = '';

        const $ = (id) => document.getElementById(id);
        const log = (message, type = 'info') => {
            const output = $('status-output');
            const color = type === 'error' ? 'text-red-400' : (type === 'success' ? 'text-green-400' : 'text-gray-300');
            output.innerHTML = `<p class="flex items-center space-x-2"><span class="${color}">${type === 'error' ? 'üõë' : (type === 'success' ? 'üéâ' : '‚û°Ô∏è')}</span><span>${message}</span></p>` + output.innerHTML;
        };

        const toggleLoading = (isLoading) => {
            const button = $('post-button');
            const spinner = $('post-spinner');
            const text = $('button-text');
            
            button.disabled = isLoading;
            if (isLoading) {
                spinner.classList.remove('hidden');
                text.textContent = 'Posting... Please wait.';
                button.classList.add('opacity-70');
            } else {
                spinner.classList.add('hidden');
                text.textContent = 'Post Now';
                button.classList.remove('opacity-70');
            }
        };

        const checkSelection = () => {
            selectedDate = $('content-date').value;
            const token = $('github-token').value;
            const canPost = selectedDate && token;
            $('post-button').disabled = !canPost;
            if (canPost) {
                $('button-text').textContent = `Post Content from ${selectedDate}`;
            } else if (!selectedDate) {
                $('button-text').textContent = 'Please select a content date';
            }
        };


        // ======================================================================
        // 3. AUTHENTICATION LOGIC
        // ======================================================================

        function handleLogin() {
            const username = $('username').value;
            const password = $('password').value;
            const message = $('login-message');

            if (username === AUTH_USERNAME && password === AUTH_PASSWORD) {
                $('login-screen').classList.add('hidden');
                $('dashboard-screen').classList.remove('hidden');
                message.textContent = '';
                log('Authentication successful. Welcome!');
                // Automatically set up event listener after successful login
                $('github-token').addEventListener('input', checkSelection);
                $('content-date').addEventListener('change', checkSelection);
                // Also trigger an initial fetch attempt
                fetchContentDates();
            } else {
                message.textContent = 'Invalid username or secret code.';
            }
        }

        // ======================================================================
        // 4. GITHUB CONTENT FETCHING
        // ======================================================================

        async function fetchContentDates() {
            const token = $('github-token').value;
            const selectElement = $('content-date');
            
            if (!token) {
                log('Please enter your GitHub Token first.', 'error');
                return;
            }
            githubToken = token;
            
            $('refresh-text').textContent = 'Fetching...';
            $('refresh-icon').textContent = '‚öôÔ∏è';
            selectElement.innerHTML = '<option value="" disabled selected>Loading dates...</option>';
            $('post-button').disabled = true;

            const url = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${CONTENT_BASE_PATH}`;
            
            log(`Connecting to GitHub to fetch directories in /${CONTENT_BASE_PATH}/...`);

            try {
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (response.status === 401 || response.status === 403) {
                    throw new Error('Invalid GitHub Token or insufficient permissions.');
                }
                if (!response.ok) {
                    throw new Error(`GitHub API Error: ${response.statusText}`);
                }

                const data = await response.json();
                
                const dateFolders = data
                    .filter(item => item.type === 'dir' && /^\d{4}-\d{2}-\d{2}$/.test(item.name))
                    .map(item => item.name)
                    .sort().reverse(); // Sort descending by date

                selectElement.innerHTML = '';
                if (dateFolders.length === 0) {
                    selectElement.innerHTML = '<option value="" disabled selected>No date folders found.</option>';
                    log('No date folders (YYYY-MM-DD) found in the content path.', 'info');
                } else {
                    selectElement.innerHTML = '<option value="" disabled selected>-- Select a Folder --</option>';
                    dateFolders.forEach(date => {
                        const option = document.createElement('option');
                        option.value = date;
                        option.textContent = date;
                        selectElement.appendChild(option);
                    });
                    log(`Successfully found ${dateFolders.length} content folders.`, 'success');
                }
            } catch (error) {
                log(`Failed to fetch content dates: ${error.message}`, 'error');
                selectElement.innerHTML = '<option value="" disabled selected>Fetch failed. Check token.</option>';
            } finally {
                $('refresh-text').textContent = 'Refresh Dates';
                $('refresh-icon').textContent = 'üîÑ';
                checkSelection();
            }
        }


        // ======================================================================
        // 5. GEMINI AI CAPTION GENERATION
        // ======================================================================
        
        async function generateAICaption() {
            const topic = $('ai-topic').value.trim();
            const platform = $('ai-platform').value;
            const tone = $('ai-tone').value.trim();
            const generateButton = $('ai-generate-button');
            const outputArea = $('ai-output');

            if (!topic) {
                log('Please provide a core post topic.', 'error');
                return;
            }

            generateButton.disabled = true;
            generateButton.textContent = 'Generating Caption...';
            outputArea.value = '';
            log(`\n--- Requesting AI Caption for ${platform} ---`, 'info');

            const platformInstruction = platform === 'LinkedIn' 
                ? 'Generate a professional, high-value post, focusing on business and career insights. Include relevant hashtags.'
                : 'Generate a creative, engaging, and visually appealing caption. Use appropriate emojis and trending hashtags.';

            const systemPrompt = `You are a friendly and encouraging social media manager focused on growth. ${platformInstruction} The tone must be: ${tone}. Provide only the caption text, without any introductory or concluding remarks.`;
            
            const userQuery = `Core topic: ${topic}.`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                // The GEMINI_API_KEY is an empty string, which the canvas environment automatically handles.
                const response = await fetch(GEMINI_API_URL + `?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API call failed with status: ${response.status}`);
                }

                const result = await response.json();
                const generatedText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (generatedText) {
                    outputArea.value = generatedText;
                    log('üéâ AI Caption generated successfully!', 'success');
                } else {
                    throw new Error('AI response was empty or malformed.');
                }

            } catch (error) {
                log(`üõë AI Generation Error: ${error.message}`, 'error');
                outputArea.value = `Error generating caption: ${error.message}`;
            } finally {
                generateButton.disabled = false;
                generateButton.textContent = 'Generate Caption with AI';
            }
        }
        
        // ======================================================================
        // 6. SOCIAL MEDIA POSTING LOGIC (Converted from Python)
        // ======================================================================
        
        const getFileUrl = (date, filename) => {
            return `https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/${BRANCH}/${CONTENT_BASE_PATH}/${date}/${filename}`;
        };

        async function fetchCaption(url) {
            log(`   Fetching caption from: ${url}`);
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`Failed to fetch caption (Status: ${response.status}). Check if file exists.`);
            }
            return (await response.text()).trim();
        }

        async function fetchImageBlob(url) {
            log(`   Fetching image data from: ${url}`);
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`Failed to fetch image (Status: ${response.status}). Check if file exists.`);
            }
            // Use response.blob() for LinkedIn raw upload
            return await response.blob(); 
        }

        // --- LINKEDIN POSTING ---
        async function postToLinkedIn(date) {
            log('Starting LinkedIn 3-step posting process...', 'info');

            const CAPTION_URL = getFileUrl(date, 'caption_linkedin.txt');
            const IMAGE_URL = getFileUrl(date, 'image.png');

            let assetUrn = '';

            try {
                const POST_TEXT = await fetchCaption(CAPTION_URL);
                const imageBlob = await fetchImageBlob(IMAGE_URL);

                // 1. Register the image upload
                const registerUrl = "https://api.linkedin.com/v2/assets?action=registerUpload";
                const headers = {
                    "Authorization": `Bearer ${ACCESS_TOKEN_LI}`,
                    "Content-Type": "application/json"
                };
                const registerBody = {
                    "registerUploadRequest": {
                        "recipes": ["urn:li:digitalmediaRecipe:feedshare-image"],
                        "owner": PERSON_URN,
                        "serviceRelationships": [
                            {"relationshipType": "OWNER", "identifier": "urn:li:userGeneratedContent"}
                        ]
                    }
                };

                const res1 = await fetch(registerUrl, { method: 'POST', headers, body: JSON.stringify(registerBody) });
                if (!res1.ok) throw new Error(`Step 1 (Register) failed: ${res1.status} ${await res1.text()}`);
                
                const registerData = await res1.json();
                const uploadUrl = registerData.value.uploadMechanism['com.linkedin.digitalmedia.uploading.MediaUploadHttpRequest'].uploadUrl;
                assetUrn = registerData.value.asset;
                log(`‚úÖ LinkedIn Step 1: Registered upload. Asset URN: ${assetUrn}`);

                // 2. Upload the image
                const uploadHeaders = { 
                    "Authorization": `Bearer ${ACCESS_TOKEN_LI}`, 
                    "Content-Type": "application/octet-stream" 
                };
                const res2 = await fetch(uploadUrl, { method: 'PUT', headers: uploadHeaders, body: imageBlob });
                if (!res2.ok) throw new Error(`Step 2 (Upload) failed: ${res2.status} ${await res2.text()}`);
                log('‚úÖ LinkedIn Step 2: Image uploaded successfully.');

                // 3. Post the content
                const postUrl = "https://api.linkedin.com/v2/ugcPosts";
                const postBody = {
                    "author": PERSON_URN,
                    "lifecycleState": "PUBLISHED",
                    "specificContent": {
                        "com.linkedin.ugc.ShareContent": {
                            "shareCommentary": {"text": POST_TEXT},
                            "shareMediaCategory": "IMAGE",
                            "media": [
                                {"status": "READY", "media": assetUrn}
                            ]
                        }
                    },
                    "visibility": {"com.linkedin.ugc.MemberNetworkVisibility": "PUBLIC"}
                };
                const res3 = await fetch(postUrl, { method: 'POST', headers, body: JSON.stringify(postBody) });
                if (!res3.ok) throw new Error(`Step 3 (Post) failed: ${res3.status} ${await res3.text()}`);
                
                log('üéâ LinkedIn Post created successfully!', 'success');

            } catch (error) {
                log(`üõë LinkedIn Post failed: ${error.message}`, 'error');
            }
        }

        // --- INSTAGRAM POSTING ---
        async function postToInstagram(date) {
            log('Starting Instagram 2-step posting process...', 'info');

            const CAPTION_URL = getFileUrl(date, 'caption_instagram.txt');
            const IMAGE_URL = getFileUrl(date, 'image.png');
            let mediaContainerId = '';

            try {
                const CAPTION_TEXT = await fetchCaption(CAPTION_URL);
                
                // 1. Create Media Container with Caption
                const mediaUrl = `https://graph.facebook.com/v17.0/${INSTAGRAM_BUSINESS_ID}/media`;
                
                // Use URLSearchParams for form-data style parameters
                const mediaParams = new URLSearchParams({
                    image_url: IMAGE_URL,
                    caption: CAPTION_TEXT,
                    access_token: ACCESS_TOKEN_IG
                });

                const res1 = await fetch(mediaUrl, { 
                    method: 'POST', 
                    body: mediaParams
                });

                if (!res1.ok) throw new Error(`Step 1 (Container) failed: ${res1.status} ${await res1.text()}`);
                
                const data1 = await res1.json();
                mediaContainerId = data1.id;
                if (!mediaContainerId) throw new Error('Container ID not found in response.');

                log(`‚úÖ Instagram Step 1: Media container created. ID: ${mediaContainerId}`);

                // 2. Publish the Media
                const publishUrl = `https://graph.facebook.com/v17.0/${INSTAGRAM_BUSINESS_ID}/media_publish`;
                const publishParams = new URLSearchParams({
                    creation_id: mediaContainerId,
                    access_token: ACCESS_TOKEN_IG
                });

                const res2 = await fetch(publishUrl, {
                    method: 'POST',
                    body: publishParams
                });

                if (!res2.ok) throw new Error(`Step 2 (Publish) failed: ${res2.status} ${await res2.text()}`);

                log('üéâ Instagram Post published successfully!', 'success');

            } catch (error) {
                log(`üõë Instagram Post failed: ${error.message}`, 'error');
            }
        }

        // ======================================================================
        // 7. MAIN HANDLER
        // ======================================================================

        async function handlePost() {
            const date = $('content-date').value;
            const postToLinkedInChecked = $('platform-linkedin').checked;
            const postToInstagramChecked = $('platform-instagram').checked;

            if (!date) {
                log('Please select a content date first.', 'error');
                return;
            }

            if (!postToLinkedInChecked && !postToInstagramChecked) {
                log('Please select at least one platform to post to.', 'error');
                return;
            }

            toggleLoading(true);
            log(`\n--- Starting Automation for Content Date: ${date} ---`, 'info');

            if (postToLinkedInChecked) {
                await postToLinkedIn(date);
            }

            if (postToInstagramChecked) {
                await postToInstagram(date);
            }

            log('\n--- Automation Sequence Complete ---', 'info');
            toggleLoading(false);
        }

        // Initialize: Check for token input changes on page load (after login)
        window.onload = () => {
             // We don't call handleLogin, just set up listener for later login success
        };
    </script>
</body>
</html>
